<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>AUTO 369° — пошук і продаж авто</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no"/>
  <meta name="format-detection" content="telephone=no"/>
  <meta name="theme-color" content="#07142e"/>
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: radial-gradient(1100px 800px at 50% 10%, #0a1f44 0%, #081939 42%, #07142e 100%);
      --paper:#fff; --ink:#000;
      --brand:#ffd33b; --brand-press:#ffbf00;
      --line:rgba(255,255,255,.14); --glass:rgba(12,20,44,.68);
      --field-bg:rgba(255,255,255,.08); --field-br:rgba(255,255,255,.22); --ph:rgba(255,255,255,.75);
      --menu-bg:#0b1635; --menu-br:rgba(255,255,255,.22); --menu-hover:rgba(255,255,255,.10);
      --top:60px;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--paper); font-family:"Montserrat",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;}

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:100; height:var(--top);
      display:flex; align-items:center; gap:10px; padding:10px 12px;
      background:linear-gradient(180deg, rgba(7,15,35,.95), rgba(7,15,35,.72));
      border-bottom:1px solid var(--line);
    }
    .logo{background:var(--brand); color:#111; border-radius:12px; padding:8px 12px; font:700 16px/1 "Russo One",sans-serif;}
    .pill{display:inline-flex; align-items:center; gap:8px; height:38px; padding:0 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.08); cursor:pointer; font-weight:700;}
    .pill.yellow{background:var(--brand); color:#111; border-color:rgba(0,0,0,.2); font-family:"Russo One"; text-transform:uppercase;}
    .grow{flex:1}

    .container{max-width:1200px; margin:12px auto; padding:0 12px;}
    .panel{background:var(--glass); border:1px solid var(--line); border-radius:16px; padding:12px; box-shadow:0 20px 40px rgba(0,0,0,.45); backdrop-filter:saturate(130%) blur(8px);}

    /* Inputs */
    .filters{display:grid; grid-template-columns:repeat(6,1fr); gap:10px;}
    @media (max-width:1024px){ .filters{grid-template-columns:repeat(3,1fr);} }
    @media (max-width:640px){ .filters{grid-template-columns:1fr 1fr;} }
    label{font-size:12px; font-weight:800; opacity:.92; display:block; margin:0 0 6px;}
    .input,.select{
      width:100%; height:46px; border-radius:12px; border:1px solid var(--field-br);
      background:var(--field-bg); color:#fff; padding:0 12px; font-size:14px; outline:none;
    }
    .input::placeholder{color:var(--ph)}
    .actions{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap}
    .btn{height:48px; border:none; border-radius:14px; background:var(--brand); color:#111; font:700 16px/48px "Russo One"; padding:0 18px; cursor:pointer; box-shadow:0 6px 0 rgba(0,0,0,.35), inset 0 -3px 0 rgba(0,0,0,.18);}
    .btn:active{transform:translateY(2px); background:var(--brand-press); box-shadow:0 4px 0 rgba(0,0,0,.35), inset 0 -2px 0 rgba(0,0,0,.18);}
    .btn.ghost{background:rgba(255,255,255,.1); color:#fff;}
    .check{display:flex; align-items:center; gap:8px; margin-top:12px; font-size:13px; opacity:.9}

    /* Nice Select (desktop) */
    @media (hover:hover){
      .select.nice-hidden{position:absolute; inset:0; opacity:0; pointer-events:none}
      .nice{position:relative}
      .nice-btn{
        width:100%; height:46px; border-radius:12px; border:1px solid var(--field-br);
        background:var(--field-bg); color:#fff; padding:0 38px 0 12px; text-align:left; font-size:14px; font-weight:600; cursor:pointer;
      }
      .nice-btn:after{content:"▾"; position:absolute; right:12px; top:50%; transform:translateY(-50%); opacity:.8; pointer-events:none}
      .nice-list{
        position:absolute; left:0; right:0; top:calc(100% + 6px);
        background:var(--menu-bg); border:1px solid var(--menu-br); border-radius:12px; padding:6px;
        box-shadow:0 18px 38px rgba(0,0,0,.6); display:none; max-height:260px; overflow:auto; z-index:200;
      }
      .nice.open .nice-list{display:block}
      .nice-item{padding:10px 12px; border-radius:10px; cursor:pointer; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
      .nice-item:hover{background:var(--menu-hover)}
      .nice-item.active{background:rgba(255,255,255,.12)}
    }

    .topline{display:flex; align-items:center; gap:10px; margin:14px 0;}
    .grid{display:grid; grid-template-columns:repeat(3,1fr); gap:12px;}
    @media (max-width:1024px){ .grid{grid-template-columns:repeat(2,1fr);} }
    @media (max-width:640px){ .grid{grid-template-columns:1fr;} }

    .card{
      background:rgba(255,255,255,.06); border:1px solid var(--line); border-radius:14px; overflow:hidden;
      display:flex; flex-direction:column; cursor:pointer; transition:transform .08s ease, box-shadow .08s ease;
    }
    .card:active{transform:translateY(1px); box-shadow:0 10px 22px rgba(0,0,0,.35)}
    .thumb{position:relative; padding-top:62%; background:#0b3a8a; overflow:hidden;}
    .thumb img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover;}
    .badge{position:absolute; left:8px; bottom:8px; background:var(--brand); color:#111; border-radius:10px; padding:6px 10px; font:700 14px/1 "Russo One";}
    .views{position:absolute; right:8px; bottom:8px; background:rgba(0,0,0,.6); border:1px solid rgba(255,255,255,.25); color:#fff; border-radius:10px; padding:5px 8px; font-weight:700; font-size:12px}
    .body{padding:10px; display:flex; flex-direction:column; gap:6px}
    .title{font:700 16px/1.2 "Russo One"; letter-spacing:.4px}
    .meta{font-size:13px; opacity:.95}

    .detail{position:fixed; inset:0; z-index:120; display:none; background:rgba(0,0,0,.5);}
    .detail.active{display:block;}
    .sheet{position:absolute; left:50%; top:6vh; transform:translateX(-50%); width:min(1080px,96vw); max-height:88vh; overflow:auto; background:var(--glass); border:1px solid var(--line); border-radius:16px; padding:12px; box-shadow:0 20px 40px rgba(0,0,0,.6); backdrop-filter:saturate(130%) blur(8px);}
    .gal{display:grid; grid-template-columns:2fr 1fr; gap:10px;}
    @media (max-width:900px){ .gal{grid-template-columns:1fr;} }
    .gal .big{position:relative; padding-top:56%; background:#0b3a8a; border-radius:12px; overflow:hidden}
    .gal .big img,.gal .sm img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover}
    .gal .sm{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .close{position:sticky; top:0; margin-left:auto}
    .specs{display:grid; grid-template-columns:repeat(4,1fr); gap:8px}
    @media (max-width:900px){ .specs{grid-template-columns:repeat(2,1fr);} }
    .spec{background:rgba(255,255,255,.06); border:1px solid var(--line); border-radius:12px; padding:8px; font-size:13px}
    .h{font:700 14px/1 "Russo One"; margin-bottom:6px}
    .divider{height:1px; background:var(--line); margin:10px 0}
    .seller{display:flex; gap:10px; align-items:center}
    .avatar{width:44px; height:44px; border-radius:50%; background:#203157; display:flex; align-items:center; justify-content:center; font-weight:800}

    /* Modal add */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:140}
    .modal.active{display:flex}
    .modal .window{width:min(1080px,96vw); max-height:90vh; overflow:auto; background:var(--glass); border:1px solid var(--line); border-radius:16px; padding:12px; box-shadow:0 20px 40px rgba(0,0,0,.65); backdrop-filter:saturate(130%) blur(8px);}
    .modal .titlebar{display:flex; align-items:center; gap:8px; margin-bottom:8px}
    .modal .x{margin-left:auto}
    .pager{display:flex; align-items:center; justify-content:center; gap:8px; margin:16px 0 40px}
    .pager .pg-btn{min-width:44px; height:44px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.08); color:#fff; font-weight:800; cursor:pointer}
    .pager .pg-btn[disabled]{opacity:.45; cursor:default}
    .pager .pg-info{opacity:.9; font-weight:700}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="logo">AUTO 369°</div>
    <div class="pill yellow" id="tabSearch">Пошук</div>
    <div class="pill" id="btnOpenAdd">Додати оголошення</div>
    <div class="grow"></div>
    <label class="pill" style="cursor:pointer">
      <input type="file" id="importJson" accept="application/json" style="display:none">
      Імпорт JSON
    </label>
    <button class="pill" id="btnClear">Очистити базу</button>
  </header>

  <main class="container">
    <!-- ФІЛЬТРИ -->
    <section class="panel" id="searchPanel">
      <div class="filters" id="filters">
        <div><label>Область</label><select class="select" id="fltRegion"></select></div>
        <div><label>Місто</label><select class="select" id="fltCity"></select></div>
        <div><label>Пошук міста</label>
          <input class="input" id="fltCityText" list="cityDL" placeholder="Почніть вводити...">
          <datalist id="cityDL"></datalist>
        </div>

        <div><label>Марка</label><select class="select" id="fltBrand"></select></div>
        <div><label>Модель</label><select class="select" id="fltModel"></select></div>

        <div><label>Рік від</label><select class="select" id="fltYearMin"></select></div>
        <div><label>Рік до</label><select class="select" id="fltYearMax"></select></div>

        <div><label>Ціна від, $</label><input class="input" id="fltPriceMin" placeholder="0"></div>
        <div><label>Ціна до, $</label><input class="input" id="fltPriceMax" placeholder="∞"></div>
        <div><label>Пробіг до, тис. км</label><input class="input" id="fltMileageMax" placeholder="∞"></div>
        <div><label>Паливо</label><select class="select" id="fltFuel"></select></div>
        <div><label>Коробка</label><select class="select" id="fltGear"></select></div>
        <div><label>Привід</label><select class="select" id="fltDrive"></select></div>

        <div><label>Кузов</label><select class="select" id="fltBody"></select></div>
        <div><label>Колір</label><select class="select" id="fltColor"></select></div>
        <div><label>Потужність від, к.с.</label><input class="input" id="fltPowerMin" placeholder="0"></div>
        <div><label>Пошук (назва/VIN)</label><input class="input" id="fltQuery" placeholder="напр., Tesla, AA...VIN"></div>
        <div class="check"><input type="checkbox" id="fltRecent"> <label for="fltRecent">За 30 днів</label></div>
      </div>
      <div class="actions">
        <button class="btn" id="btnApply">Знайти</button>
        <button class="btn ghost" id="btnReset">Скинути</button>
        <select class="select" id="sortBy" style="max-width:240px">
          <option value="new">Сортувати: нові</option>
          <option value="priceAsc">Ціна ↑</option>
          <option value="priceDesc">Ціна ↓</option>
          <option value="yearDesc">Рік ↓</option>
          <option value="mileageAsc">Пробіг ↑</option>
          <option value="powerDesc">Потужність ↓</option>
          <option value="viewsDesc">Перегляди ↓</option>
        </select>
      </div>
    </section>

    <!-- РЕЗУЛЬТАТИ -->
    <section class="topline">
      <div id="resCount" class="muted">0 результатів</div>
      <div class="grow"></div>
    </section>
    <section class="grid" id="grid"></section>
    <div class="pager" id="pager" aria-label="Пагінація">
      <button class="pg-btn" id="pgPrev">←</button>
      <div class="pg-info" id="pgInfo">Сторінка 1/1</div>
      <button class="pg-btn" id="pgNext">→</button>
    </div>
  </main>

  <!-- DETAIL -->
  <div id="detail" class="detail">
    <div class="sheet">
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px">
        <div class="logo">AUTO 369°</div>
        <div class="grow"></div>
        <button class="btn close" id="dClose" style="height:38px; line-height:38px; border-radius:12px; font:700 13px/38px 'Russo One'">Закрити</button>
      </div>
      <div id="dHeader" style="display:flex; align-items:center; gap:10px; margin-bottom:8px"></div>
      <div class="gal" id="dGal"></div>
      <div class="divider"></div>
      <div class="specs" id="dSpecs"></div>
      <div class="divider"></div>
      <div id="dDesc" class="muted"></div>
      <div class="divider"></div>
      <div class="seller" id="dSeller"></div>
    </div>
  </div>

  <!-- ADD MODAL -->
  <div class="modal" id="addModal" role="dialog" aria-modal="true" aria-label="Додати оголошення">
    <div class="window">
      <div class="titlebar">
        <div class="logo">AUTO 369°</div>
        <div style="font:700 16px/1 'Russo One'">Додати оголошення</div>
        <button class="btn ghost x" id="btnCloseAdd" style="height:38px; line-height:38px">Закрити</button>
      </div>
      <section id="sellPanel" class="panel" style="background:transparent; border:none; box-shadow:none; backdrop-filter:none; padding:0">
        <div class="filters" style="grid-template-columns:repeat(3,1fr)">
          <div><label>Місто</label><select class="select" id="sCity"></select></div>
          <div><label>Розділ</label><select class="select" id="sSection"></select></div>

          <div><label>Марка</label><select class="select" id="sBrand"></select></div>
          <div><label>Модель</label><select class="select" id="sModel"></select></div>
          <div id="brandOtherWrap" style="display:none"><label>Інша марка</label><input class="input" id="sBrandOther" placeholder="Введіть марку"></div>

          <div><label>Рік</label><input class="input" id="sYear" placeholder="2018"></div>
          <div><label>Пробіг, км</label><input class="input" id="sMileage" placeholder="95000"></div>
          <div><label>Паливо</label><select class="select" id="sFuel"></select></div>
          <div><label>Коробка</label><select class="select" id="sGear"></select></div>
          <div><label>Привід</label><select class="select" id="sDrive"></select></div>
          <div><label>Кузов</label><select class="select" id="sBody"></select></div>
          <div><label>Колір</label><select class="select" id="sColor"></select></div>
          <div><label>Потужність, к.с.</label><input class="input" id="sPower" placeholder="120"></div>
          <div><label>Ціна, $</label><input class="input" id="sPrice" placeholder="13500"></div>
          <div><label>VIN (опц.)</label><input class="input" id="sVIN" placeholder="WAUZZZ..."></div>
          <div><label>Телефон</label><input class="input" id="sPhone" placeholder="+380..."></div>
          <div style="grid-column:1/-1"><label>Опис</label><textarea class="input" id="sDesc" rows="3" style="height:auto; padding:10px" placeholder="Стан, комплектація... (мін. 20 символів)"></textarea></div>
          <div style="grid-column:1/-1"><label>Зображення (URL або data: через кому)</label><input class="input" id="sImages" placeholder="https://...jpg, https://...jpg"></div>
        </div>
        <div class="actions">
          <button class="btn" id="sSave">Опублікувати</button>
          <div class="muted">Антиспам: 1 оголошення / 60 сек.</div>
        </div>
      </section>
    </div>
  </div>

  <script>
  // ====== Легка, безпечна робота зі сховищем (localStorage → sessionStorage) ======
  const SAFE = {
    get(k){ try{ return localStorage.getItem(k) ?? sessionStorage.getItem(k); }catch{ try{ return sessionStorage.getItem(k); }catch{ return null } },
    set(k,v){
      try{ localStorage.setItem(k,v); return 'local'; }
      catch(e){
        try{ sessionStorage.setItem(k,v); alert("Місця в памʼяті браузера не вистачає — дані збережені тимчасово (до перезавантаження)."); return 'session'; }
        catch{ console.warn("Storage failed"); return 'none'; }
      }
    },
    del(k){ try{ localStorage.removeItem(k) }catch{} try{ sessionStorage.removeItem(k) }catch{} }
  };

  const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
  const EXTRA_KEY="auto369_extras";   // зберігаємо тільки «додані/імпортовані»
  const CTRL_KEY ="auto369_ctrl";     // дрібні налаштування/таймери антиспаму

  // ==== довідники ====
  const DRIVE=["FWD","RWD","AWD"];
  const BODIES=["Седан","Хетчбек","Кросовер","Універсал","Мінівен","Купе","Пікап","Позашляховик","Кабріолет","Ліфтбек","Фургон"];
  const COLORS=["Чорний","Білий","Сірий","Синій","Червоний","Зелений","Коричневий","Сріблястий","Жовтий","Помаранчевий","Бежевий"];
  const FUELS=["Бензин","Дизель","Гібрид","Електро","ГАЗ"];
  const GEARS=["Механіка","Автомат","Варіатор","Робот"];
  const SECTIONS=["Легкові","Кросовери","Електро","Вани/Мікроавтобуси","Пікапи","Позашляховики"];
  const YEARS=Array.from({length:31},(_,i)=>1995+i);

  const REGIONS={
    "Автономна Республіка Крим":["Сімферополь","Ялта","Керч","Євпаторія"],
    "Вінницька":["Вінниця","Жмеринка","Хмільник","Козятин","Могилів-Подільський"],
    "Волинська":["Луцьк","Ковель","Нововолинськ"],
    "Дніпропетровська":["Дніпро","Кривий Ріг","Кам'янське","Нікополь","Павлоград"],
    "Донецька":["Донецьк","Маріуполь","Краматорськ","Слов'янськ","Бахмут"],
    "Житомирська":["Житомир","Бердичів","Новоград-Волинський"],
    "Закарпатська":["Ужгород","Мукачево","Хуст","Берегове"],
    "Запорізька":["Запоріжжя","Мелітополь","Бердянськ","Енергодар"],
    "Івано-Франківська":["Івано-Франківськ","Калуш","Коломия"],
    "Київська":["Київ","Біла Церква","Бровари","Бориспіль","Ірпінь","Буча","Фастів","Вишгород"],
    "Кіровоградська":["Кропивницький","Олександрія","Світловодськ"],
    "Луганська":["Луганськ","Сєвєродонецьк","Лисичанськ","Рубіжне"],
    "Львівська":["Львів","Дрогобич","Стрий","Червоноград","Самбір","Трускавець"],
    "Миколаївська":["Миколаїв","Первомайськ","Вознесенськ","Очаків"],
    "Одеська":["Одеса","Чорноморськ","Южне","Ізмаїл","Біляївка"],
    "Полтавська":["Полтава","Кременчук","Лубни","Миргород"],
    "Рівненська":["Рівне","Дубно","Кузнецовськ"],
    "Сумська":["Суми","Конотоп","Шостка","Охтирка"],
    "Тернопільська":["Тернопіль","Чортків","Кременець"],
    "Харківська":["Харків","Лозова","Ізюм","Чугуїв"],
    "Херсонська":["Херсон","Нова Каховка","Каховка"],
    "Хмельницька":["Хмельницький","Кам'янець-Подільський","Шепетівка"],
    "Черкаська":["Черкаси","Умань","Сміла"],
    "Чернівецька":["Чернівці","Новодністровськ"],
    "Чернігівська":["Чернігів","Ніжин","Прилуки"],
    "м. Київ":["Київ"],
    "м. Севастополь":["Севастополь"]
  };

  // Великий список брендів + «Інша марка…»
  const BRANDS={
    "Toyota":["Corolla","Camry","RAV4","Land Cruiser","Yaris","Prius","Avensis","Auris","C-HR","Highlander","Hilux"],
    "Volkswagen":["Golf","Passat","Tiguan","Polo","Touareg","Jetta","Transporter","T-Roc","Caddy","Multivan"],
    "BMW":["1 Series","2 Series","3 Series","4 Series","5 Series","7 Series","X1","X3","X5","X6","i3","i8"],
    "Mercedes-Benz":["A-Class","B-Class","C-Class","E-Class","S-Class","GLA","GLC","GLE","GLS","Vito","Sprinter"],
    "Audi":["A1","A3","A4","A6","A8","Q2","Q3","Q5","Q7","Q8","e-tron"],
    "Skoda":["Fabia","Octavia","Superb","Kodiaq","Karoq","Scala","Kamiq"],
    "Renault":["Clio","Megane","Kadjar","Duster","Kangoo","Trafic","Talisman","Captur"],
    "Hyundai":["i20","i30","Elantra","Tucson","Santa Fe","Accent","Kona","Creta","Venue"],
    "Kia":["Rio","Ceed","Sportage","Sorento","Soul","Picanto","Seltos","K5"],
    "Nissan":["Micra","Juke","Qashqai","X-Trail","Leaf","Navara","Note","Terrano"],
    "Ford":["Fiesta","Focus","Mondeo","Kuga","EcoSport","Transit","Ranger","Explorer"],
    "Opel":["Corsa","Astra","Insignia","Mokka","Zafira","Vivaro","Grandland X"],
    "Mazda":["2","3","6","CX-3","CX-5","CX-30","CX-9","MX-5"],
    "Honda":["Civic","Accord","CR-V","HR-V","Jazz","Pilot","Fit","Insight"],
    "Peugeot":["108","208","308","508","2008","3008","5008","Partner","Rifter"],
    "Citroen":["C1","C3","C4","C5","C-Elysee","Berlingo","Jumpy"],
    "Volvo":["S40","S60","S90","V40","V60","XC40","XC60","XC90"],
    "Subaru":["Impreza","Legacy","Forester","Outback","XV","BRZ"],
    "Mitsubishi":["Lancer","ASX","Outlander","Pajero","Eclipse Cross"],
    "Tesla":["Model 3","Model S","Model Y","Model X"],
    "Chevrolet":["Aveo","Cruze","Captiva","Equinox","Malibu","Spark","Tahoe"],
    "Jeep":["Renegade","Compass","Cherokee","Grand Cherokee","Wrangler"],
    "Fiat":["Panda","Punto","Tipo","Doblo","Talento","500","500X"],
    "Porsche":["Macan","Cayenne","Panamera","Taycan"],
    "Lexus":["IS","ES","GS","RX","NX","UX","LX","GX"],
    "Alfa Romeo":["Giulietta","Giulia","Stelvio","Mito"],
    "SEAT":["Ibiza","Leon","Ateca","Arona","Tarraco","Toledo"],
    "Dacia":["Logan","Sandero","Duster","Dokker","Lodgy"],
    "Land Rover":["Range Rover","Range Rover Sport","Discovery","Evoque","Defender"],
    "Jaguar":["XE","XF","XJ","F-Pace","E-Pace","I-Pace"],
    "MINI":["One","Cooper","Clubman","Countryman"],
    "Suzuki":["Swift","Vitara","SX4","Jimny","Ignis","S-Cross"],
    "Infiniti":["Q30","Q50","QX30","QX50","QX70"],
    "Acura":["ILX","TLX","RDX","MDX","NSX"],
    "Cadillac":["ATS","CTS","XT5","Escalade","SRX"],
    "Buick":["Encore","Enclave","Regal","LaCrosse"],
    "Chrysler":["200","300","Pacifica","Voyager"],
    "Dodge":["Neon","Avenger","Charger","Durango","Journey"],
    "RAM":["1500","2500","3500"],
    "GMC":["Terrain","Acadia","Yukon","Sierra"],
    "Lincoln":["MKZ","MKX","Nautilus","Aviator"],
    "Saab":["9-3","9-5"],
    "Lada":["2107","Priora","Vesta","Granta","Niva"],
    "ZAZ":["Lanos","Sens","Vida"],
    "Daewoo":["Lanos","Nexia","Matiz"],
    "Geely":["CK","Emgrand","Atlas","Coolray"],
    "Great Wall":["Hover","Wingle"],
    "BYD":["F3","Tang","Han","Atto 3"],
    "Chery":["QQ","Tiggo 2","Tiggo 4","Tiggo 7","Tiggo 8"],
    "Haval":["H2","H6","Jolion"],
    "MG":["ZS","HS","5","3","GS"],
    "SsangYong":["Kyron","Actyon","Tivoli","Korando"],
    "Rover":["25","45","75"],
    "Інша марка…":[]
  };

  // ===== Глобальні утиліти
  const uid=()=>Math.random().toString(16).slice(2)+Date.now().toString(16);
  const rand=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const pick=a=>a[rand(0,a.length-1)];

  function carPNG(title, seed=0, body="Седан", colorIdx=0){
    const c=document.createElement('canvas'); c.width=800; c.height=500;
    const g=c.getContext('2d');
    const palettes=[["#0e2a58","#163b7a","#0b1d3b"],["#3a1f5d","#532e8a","#1b0f2f"],["#0b3a2e","#147a60","#06241d"],["#6b1f1f","#a23333","#240909"]];
    const pal=palettes[colorIdx%palettes.length];
    const grad=g.createLinearGradient(0,0,800,500); grad.addColorStop(0,pal[0]); grad.addColorStop(1,pal[1]);
    g.fillStyle=grad; g.fillRect(0,0,800,500); g.fillStyle=pal[2]; g.fillRect(0,400,800,100);
    g.fillStyle="rgba(0,0,0,.25)"; g.beginPath(); g.ellipse(400,390,260,40,0,0,Math.PI*2); g.fill();
    const carColors=['#ffcf33','#e74c3c','#2ecc71','#3498db','#9b59b6','#f39c12','#1abc9c','#ecf0f1']; const cc=carColors[(seed+3)%carColors.length];
    function wheel(x,y){ g.fillStyle='#111'; g.beginPath(); g.arc(x,y,48,0,Math.PI*2); g.fill(); g.fillStyle='#bbb'; g.beginPath(); g.arc(x,y,20,0,Math.PI*2); g.fill(); }
    wheel(280,380); wheel(540,380);
    g.fillStyle=cc; g.strokeStyle='#00000040'; g.lineWidth=2;
    if(body==='Кросовер'||body==='Позашляховик'){ g.beginPath(); g.moveTo(180,360); g.lineTo(180,330); g.lineTo(260,300); g.lineTo(430,290); g.lineTo(520,310); g.lineTo(600,330); g.lineTo(620,360); g.closePath(); g.fill(); g.stroke(); }
    else if(body==='Хетчбек'){ g.beginPath(); g.moveTo(160,360); g.lineTo(175,330); g.lineTo(260,300); g.lineTo(420,300); g.lineTo(520,330); g.lineTo(560,360); g.closePath(); g.fill(); g.stroke(); }
    else if(body==='Купе'){ g.beginPath(); g.moveTo(170,360); g.lineTo(210,320); g.quadraticCurveTo(360,270,520,310); g.lineTo(580,360); g.closePath(); g.fill(); g.stroke(); }
    else { g.beginPath(); g.moveTo(160,360); g.lineTo(210,320); g.quadraticCurveTo(360,270,520,310); g.lineTo(600,360); g.closePath(); g.fill(); g.stroke(); }
    g.fillStyle='rgba(255,255,255,.85)'; g.fillRect(300,305,90,35); g.fillRect(400,300,100,38);
    g.fillStyle='#fff8b0'; g.fillRect(600,340,14,10); g.fillStyle='#ff5c5c'; g.fillRect(160,340,12,10);
    g.fillStyle='#ffd33b'; g.font="bold 42px 'Russo One', Arial"; g.textAlign="center"; g.fillText(title, 400, 80);
    return c.toDataURL('image/png');
  }
  function createImg(src, alt, fallback){
    const img=document.createElement("img"); img.loading="lazy"; img.alt=alt;
    img.src = src || fallback; img.onerror=()=>{ img.onerror=null; img.src=fallback; };
    return img;
  }

  // ====== База: сид-генерація у памʼяті + «екстра» в сховищі
  let SEED_COUNT=2000;
  let DB_MEM=[]; // сид-дані (не пишемо у storage)

  function makeSeed(){
    const out=[]; const regions=Object.keys(REGIONS); const brands=Object.keys(BRANDS); let i=0;
    while(out.length<SEED_COUNT){
      const region=regions[i%regions.length];
      const city=pick(REGIONS[region]);
      const section=pick(SECTIONS);
      const brand=brands[i%brands.length];
      const model=BRANDS[brand].length? pick(BRANDS[brand]) : "Model";
      const electric=(section==="Електро")||brand==="Tesla"||model==="Leaf";
      const year=electric?rand(2014,2025):rand(2005,2025);
      const mileage=electric?rand(0,180000):rand(10000,350000);
      const fuel=electric?"Електро":pick(FUELS.filter(f=>f!=="Електро"));
      const gear=pick(GEARS), power=electric?rand(120,450):rand(70,320);
      const price=Math.max(1200,Math.round((electric?18000:5500)+(2025-year)*500+rand(-1500,7000)));
      out.push({
        id:uid(), region, city, section, brand, model, year, mileage, fuel, gear,
        drive:pick(DRIVE), body:pick(BODIES), power, color:pick(COLORS),
        price, currency:"$", created:Date.now()-rand(0,60*86400*1000),
        views:rand(100,500), vin:(Math.random()<.25?("UA"+rand(1000000,9999999)):""),
        seller:{name:pick(["Олег","Ірина","Сергій","Анна","Віктор","Максим","Марія"])+" "+pick(["К.","Л.","М.","С.","Д."]), phone:"+380"+rand(500000000,999999999)},
        desc:"Гарний стан, чесний пробіг. ТО вчасно. Деталі по телефону.",
        images:[]
      });
      i++;
    }
    DB_MEM=out;
  }
  makeSeed();

  function extrasGet(){
    try{ const raw = SAFE.get(EXTRA_KEY); return raw? JSON.parse(raw): []; }catch{ return []; }
  }
  function extrasSet(list){
    try{ SAFE.set(EXTRA_KEY, JSON.stringify(list)); }
    catch{ /* фолбек усередині SAFE.set */ }
  }

  function getDB(){ return DB_MEM.concat(extrasGet()); }

  // ====== UI-заповнення
  const fltRegion=$("#fltRegion"), fltCity=$("#fltCity"), fltCityText=$("#fltCityText"), cityDL=$("#cityDL");
  const fltBrand=$("#fltBrand"), fltModel=$("#fltModel");
  const fltYearMin=$("#fltYearMin"), fltYearMax=$("#fltYearMax"), fltFuel=$("#fltFuel"), fltGear=$("#fltGear"),
        fltDrive=$("#fltDrive"), fltBody=$("#fltBody"), fltColor=$("#fltColor"),
        fltPowerMin=$("#fltPowerMin"), fltQuery=$("#fltQuery"), fltRecent=$("#fltRecent");

  function fillSelect(el, arr, withAll=true, txt="Будь-який"){
    el.innerHTML=(withAll?`<option value="">${txt}</option>`:'')+arr.map(x=>`<option value="${x}">${x}</option>`).join('');
  }
  // Regions/cities
  const ALL_CITIES=Object.values(REGIONS).flat();
  fillSelect(fltRegion, Object.keys(REGIONS));
  function refreshCities(){
    const region=fltRegion.value;
    const list = region? REGIONS[region] : ALL_CITIES;
    fillSelect(fltCity, list, true, "Будь-яке");
  }
  refreshCities();
  cityDL.innerHTML=ALL_CITIES.map(c=>`<option value="${c}">`).join('');
  fltCityText.addEventListener('input', ()=>{
    const v=fltCityText.value.trim();
    if(!v) return;
    for(const [reg, arr] of Object.entries(REGIONS)){
      if(arr.includes(v)){ fltRegion.value=reg; refreshCities(); fltCity.value=v; break; }
    }
  });
  fltRegion.addEventListener('change', refreshCities);

  // Brands/models
  fillSelect(fltBrand,Object.keys(BRANDS));
  function refreshModels(){ const b=fltBrand.value; fillSelect(fltModel, b?BRANDS[b]:[], true, "Будь-яка"); }
  refreshModels(); fltBrand.addEventListener('change', refreshModels);

  // Other selects
  fillSelect(fltFuel,FUELS); fillSelect(fltGear,GEARS);
  fillSelect(fltDrive,DRIVE); fillSelect(fltBody,BODIES); fillSelect(fltColor,COLORS);
  fillSelect(fltYearMin,YEARS); fillSelect(fltYearMax,YEARS);

  // Кастом-селекти (десктоп)
  function enhanceSelect(sel){
    if (matchMedia('(hover: none)').matches) return;
    if (sel.classList.contains('nice-hidden')) return;
    const wrap=document.createElement('div'); wrap.className='nice';
    const btn=document.createElement('button'); btn.type='button'; btn.className='nice-btn';
    const list=document.createElement('div'); list.className='nice-list';
    const opts=[...sel.options];
    function refreshBtn(){ btn.textContent = opts[sel.selectedIndex]?.text || (sel.getAttribute('data-placeholder')||'Виберіть'); }
    opts.forEach((o, idx)=>{
      const it=document.createElement('div'); it.className='nice-item'+(o.selected?' active':''); it.textContent=o.text;
      it.onclick=(e)=>{ e.stopPropagation(); sel.selectedIndex=idx; refreshBtn(); [...list.children].forEach(c=>c.classList.remove('active')); it.classList.add('active'); closeAll(); sel.dispatchEvent(new Event('change')); };
      list.appendChild(it);
    });
    sel.classList.add('nice-hidden');
    sel.parentNode.insertBefore(wrap, sel);
    wrap.appendChild(sel); wrap.appendChild(btn); wrap.appendChild(list);
    refreshBtn();
    btn.onclick=(e)=>{ e.stopPropagation(); closeAll(); wrap.classList.toggle('open'); };
  }
  function closeAll(){ $$('.nice.open').forEach(n=>n.classList.remove('open')); }
  document.addEventListener('click', closeAll);
  $$('.select').forEach(enhanceSelect);

  // ===== ПАГІНАЦІЯ
  const grid=$("#grid"), resCount=$("#resCount"), sortBy=$("#sortBy");
  const pager=$("#pager"), pgPrev=$("#pgPrev"), pgNext=$("#pgNext"), pgInfo=$("#pgInfo");
  let page=1, pageSize=50, results=[], totalPages=1;

  function applyFilters(){
    const q=(fltQuery.value||"").trim().toLowerCase();
    const pmin= +($("#fltPriceMin").value||0);
    const pmax= +($("#fltPriceMax").value||0);
    const mmax= +($("#fltMileageMax").value||0);
    const powMin = +((fltPowerMin.value||0));

    const cityText = fltCityText.value.trim();
    const region = fltRegion.value;
    const city = fltCity.value || (ALL_CITIES.includes(cityText)? cityText : "");

    let arr=getDB().filter(it=>
      (!region || it.region===region) &&
      (!city || it.city===city) &&
      (!fltBrand.value || it.brand===fltBrand.value) &&
      (!fltModel.value || it.model===fltModel.value) &&
      (!fltFuel.value || it.fuel===fltFuel.value) &&
      (!fltGear.value || it.gear===fltGear.value) &&
      (!fltDrive.value || it.drive===fltDrive.value) &&
      (!fltBody.value || it.body===fltBody.value) &&
      (!fltColor.value || it.color===fltColor.value) &&
      (!fltYearMin.value || it.year>=+fltYearMin.value) &&
      (!fltYearMax.value || it.year<=+fltYearMax.value) &&
      (!pmin || it.price>=pmin) &&
      (!pmax || it.price<=pmax) &&
      (!mmax || (it.mileage/1000)<=mmax) &&
      (!powMin || it.power>=powMin) &&
      (!q || ( (it.brand+' '+it.model+' '+(it.vin||'')).toLowerCase().includes(q) )) &&
      (!fltRecent.checked || (Date.now()-it.created)<=30*86400*1000)
    );

    arr.sort((a,b)=>{
      switch(sortBy.value){
        case "priceAsc": return a.price-b.price;
        case "priceDesc": return b.price-a.price;
        case "yearDesc": return b.year-a.year;
        case "mileageAsc": return a.mileage-b.mileage;
        case "powerDesc": return b.power-a.power;
        case "viewsDesc": return b.views-a.views;
        default: return b.created-a.created;
      }
    });

    results=arr; totalPages=Math.max(1, Math.ceil(results.length/pageSize)); page=1;
    resCount.textContent=`${arr.length} результатів`;
    renderPage();
  }

  function renderPage(){
    grid.innerHTML="";
    const start=(page-1)*pageSize, end=start+pageSize;
    results.slice(start,end).forEach(renderCard);
    pgInfo.textContent=`Сторінка ${page} / ${totalPages}`;
    pgPrev.disabled = page<=1; pgNext.disabled = page>=totalPages;
    window.scrollTo({top:0,behavior:"smooth"});
  }

  function renderCard(it){
    const el=document.createElement('article'); el.className="card"; el.setAttribute('role','button'); el.title="Дивитися";
    const fallback=carPNG(`${it.brand} ${it.model}`, (it.year+it.price)%7, it.body, (it.power+it.year)%4);
    const firstImg=(Array.isArray(it.images)&&it.images.length)?it.images[0]:null;

    el.innerHTML=`
      <div class="thumb">
        <div class="badge">${it.price.toLocaleString('uk-UA')} ${it.currency||"$"}</div>
        <div class="views">👁 ${it.views||0}</div>
      </div>
      <div class="body">
        <div class="title">${it.brand} ${it.model} • ${it.year}</div>
        <div class="meta">${it.city}, ${it.region} • ${it.section}</div>
        <div class="meta">${(it.mileage/1000|0)} тис.км • ${it.fuel} • ${it.geар||it.gear}</div>
      </div>`;
    el.querySelector(".thumb").prepend(createImg(firstImg, `${it.brand} ${it.model}`, fallback));
    el.onclick=()=>openDetail(it.id);
    grid.appendChild(el);
  }

  $("#btnApply").onclick=applyFilters;
  $("#btnReset").onclick=()=>{$$("#searchPanel .select, #searchPanel .input").forEach(x=>x.value=""); fltRecent.checked=false; refreshCities(); refreshModels(); applyFilters();};
  $("#sortBy").onchange=()=>{ applyFilters(); };
  pgPrev.onclick=()=>{ if(page>1){ page--; renderPage(); } };
  pgNext.onclick=()=>{ if(page<totalPages){ page++; renderPage(); } };
  applyFilters();

  // ===== Деталь
  function spec(k,v){return `<div class="spec"><div class="h">${k}</div>${v}</div>`}
  function openDetail(id){
    const db=getDB(); const idx=db.findIndex(x=>x.id===id); if(idx<0) return;
    const it=db[idx];

    // views лише в пам'яті (не пишемо 2к записів у storage)
    if(DB_MEM.some(x=>x.id===id)){ DB_MEM[idx].views=(DB_MEM[idx].views||0)+1; }
    else{
      const ext = extrasGet(); const j = ext.findIndex(x=>x.id===id);
      if(j>-1){ ext[j].views=(ext[j].views||0)+1; extrasSet(ext); }
    }

    const d=$("#detail"); d.classList.add('active');
    $("#dClose").onclick=()=>{ d.classList.remove('active'); renderPage(); };

    $("#dHeader").innerHTML=`
      <div class="title" style="font:700 20px/1.2 'Russo One'">${it.brand} ${it.model} ${it.year}</div>
      <div class="pill yellow">${it.price.toLocaleString('uk-UA')} ${it.currency||"$"}</div>
      <div class="pill" style="margin-left:auto">👁 ${(it.views||0)+1}</div>
    `;

    const imgs=(Array.isArray(it.images)&&it.images.length)?it.images:[null,null,null];
    const f1=carPNG(`${it.brand} ${it.model}`,0,it.body,0), f2=carPNG(`${it.brand} ${it.model}`,1,it.body,1), f3=carPNG(`${it.brand} ${it.model}`,2,it.body,2);

    $("#dGal").innerHTML=`
      <div class="big"></div>
      <div class="sm">
        <div style="position:relative; padding-top:56%; background:#0b3a8a; border-radius:12px; overflow:hidden"></div>
        <div style="position:relative; padding-top:56%; background:#0b3a8a; border-radius:12px; overflow:hidden"></div>
      </div>`;
    $("#dGal").querySelector(".big").appendChild(createImg(imgs[0],`${it.brand}`,f1));
    const sm=$("#dGal").querySelectorAll(".sm>div");
    sm[0].appendChild(createImg(imgs[1],`${it.brand}`,f2));
    sm[1].appendChild(createImg(imgs[2],`${it.brand}`,f3));

    $("#dSpecs").innerHTML=`
      ${spec("Область",it.region)} ${spec("Місто",it.city)} ${spec("Розділ",it.section)} ${spec("Пробіг",(it.mileage/1000|0)+" тис.км")}
      ${spec("Паливо",it.fuel)} ${spec("Коробка",it.geар||it.gear)} ${spec("Привід",it.drive)}
      ${spec("Кузов",it.body)} ${spec("Потужність",it.power+" к.с.")} ${spec("Колір",it.color)} ${spec("VIN",it.vin||"—")}
    `;
    $("#dDesc").textContent = it.desc||"";
    $("#dSeller").innerHTML=`<div class="avatar">${(it.seller?.name||"П")[0]}</div>
      <div><div class="h">Продавець</div><div>${it.seller?.name||"Продавець"}</div><div class="small">${it.seller?.phone||""}</div></div>`;
  }

  // ===== Модалка «Додати»
  const addModal=$("#addModal");
  $("#btnOpenAdd").onclick=()=>{ addModal.classList.add('active'); };
  $("#btnCloseAdd").onclick=()=>{ addModal.classList.remove('active'); };

  // Форма «додати»
  const mapSelectData={sCity:Object.values(REGIONS).flat(), sSection:SECTIONS, sFuel:FUELS, sGear:GEARS, sDrive:DRIVE, sBody:BODIES, sColor:COLORS, sBrand:Object.keys(BRANDS)};
  function fillSelectSimple(el, arr){ el.innerHTML=arr.map(x=>`<option value="${x}">${x}</option>`).join(''); }
  Object.keys(mapSelectData).forEach(id=>fillSelectSimple($("#"+id), mapSelectData[id]));
  fillSelectSimple($("#sModel"), []);
  $("#sBrand").addEventListener("change", ()=>{
    const b=$("#sBrand").value;
    $("#brandOtherWrap").style.display = (b==="Інша марка…")?"block":"none";
    fillSelectSimple($("#sModel"), BRANDS[b]||[]);
  });

  function getCtrl(){ try{ return JSON.parse(SAFE.get(CTRL_KEY)||"{}"); }catch{ return {} } }
  function setCtrl(v){ SAFE.set(CTRL_KEY, JSON.stringify(v)); }

  $("#sSave").onclick=()=>{
    const ctrl=getCtrl(); const now=Date.now();
    if(ctrl.lastPost && now-ctrl.lastPost<60000){ alert("Публікувати можна не частіше 1 разу на 60 сек."); return; }
    const city=$("#sCity").value, section=$("#sSection").value;
    let brand=$("#sBrand").value; if(brand==="Інша марка…"){ brand=($("#sBrandOther").value||"Other").trim(); if(!brand) return alert("Вкажіть марку."); }
    const model=$("#sModel").value || "Model";
    if(!city||!section||!brand) return alert("Заповніть місто/розділ/марку.");
    const year=+($("#sYear").value||0); if(!(year>=1990 && year<=2025)) return alert("Рік 1990–2025.");
    const price=+($("#sPrice").value||0); if(!(price>=500 && price<=500000)) return alert("Ціна $500–500000.");
    const phone=$("#sPhone").value.trim(); if(!/^\+?\d[\d\s\-]{8,}$/.test(phone)) return alert("Телефон некоректний.");
    const vin=$("#sVIN").value.trim(); if(vin && !/^[A-HJ-NPR-Z0-9]{8,17}$/i.test(vin)) return alert("VIN 8–17 символів.");
    const desc=$("#sDesc").value.trim(); if(desc.length<20) return alert("Опис ≥ 20 символів.");

    const mileage=+($("#sMileage").value||0), fuel=$("#sFuel").value, gear=$("#sGear").value,
          drive=$("#sDrive").value, body=$("#sBody").value, color=$("#sColor").value, power=+($("#sPower").value||100);
    const images=($("#sImages").value||"").split(",").map(s=>s.trim()).filter(Boolean).slice(0,3);

    const ext=extrasGet();
    if(vin && (ext.some(x=>x.vin && x.vin===vin) || DB_MEM.some(x=>x.vin && x.vin===vin))) return alert("Авто з таким VIN вже існує.");

    ext.unshift({
      id:uid(), region:"", city, section, brand, model, year, mileage, fuel, gear, drive, body, power, color,
      price, currency:"$", created: now, vin, seller:{name:"Приватний продавець", phone}, desc, views: rand(5,25), images
    });
    extrasSet(ext); ctrl.lastPost=now; setCtrl(ctrl);
    alert("Оголошення опубліковано.");
    addModal.classList.remove('active');
    applyFilters();
  };

  // ===== Імпорт JSON (масив об'єктів формату, описаного нижче)
  document.getElementById("importJson").addEventListener("change", async (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    try{
      const arr=JSON.parse(await f.text());
      if(!Array.isArray(arr)) throw new Error("JSON має бути масивом");
      const ext=extrasGet();
      arr.forEach(o=>{
        ext.push({
          id:uid(), region:o.region||"", city:o.city||"Київ", section:o.section||"Легкові",
          brand:o.brand||"Brand", model:o.model||"Model", year:+o.year||2020, mileage:+o.mileage||rand(10000,200000),
          fuel:o.fuel||"Бензин", gear:o.gear||"Автомат", drive:o.drive||"FWD", body:o.body||"Седан",
          power:+o.power||120, color:o.color||"Сірий", price:+o.price||10000, currency:o.currency||"$",
          created:+o.created||Date.now(), vin:o.vin||"", seller:o.seller||{name:"Імпорт", phone:"+380"},
          desc:o.desc||"Імпортоване оголошення.", images:Array.isArray(o.images)?o.images.slice(0,3):[], views:+o.views||rand(150,500)
        });
      });
      extrasSet(ext);
      applyFilters(); alert("Імпортовано!");
    }catch(err){ alert("Помилка імпорту: "+err.message); }
    e.target.value="";
  });

  // Очистити локальну базу (на випадок переповнення)
  document.getElementById("btnClear").onclick=()=>{
    SAFE.del(EXTRA_KEY); SAFE.del(CTRL_KEY);
    alert("Локальна база видалена. Сид-дані (2000) залишаються."); applyFilters();
  };
  </script>
</body>
</html>
